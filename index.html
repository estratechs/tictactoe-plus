<!DOCTYPE html>
<html data-theme="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tic-Tac-Toe Plus</title>

  <!-- Single manifest link (RELATIVE for GitHub Pages) -->
  <link rel="manifest" href="manifest.json">

  <!-- Mobile Friendly CSS (RELATIVE) -->
  <!--<link rel="stylesheet" href="mobile.css">-->

  <!-- Theme color (updated dynamically) -->
  <meta name="theme-color" id="meta-theme-color" content="#ffffff"/>

  <!-- Apple PWA support -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TicTacToe Plus">

  <!-- Social cards (relative image for GH Pages) -->
  <meta property="og:title" content="TicTacToe Plus" />
  <meta property="og:description" content="A premium-feel Tic-Tac-Toe with offline support, animations, and stats." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="icons/icon-512.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <style id="pwa-theme-style">
  :root { color-scheme: light dark; }
  html[data-theme="dark"] body { background-color: #0b1220 !important; color: #e5e7eb !important; }
  html[data-theme="light"] body { background-color: #ffffff !important; color: #0f172a !important; }

  #pwa-fab {
    position: fixed; right: 16px; bottom: 16px; z-index: 2147483647;
    border: none; border-radius: 999px; padding: 12px 14px; cursor: pointer;
    background: #2563eb; color: #fff; box-shadow: 0 8px 30px rgba(0,0,0,.25);
    font: 600 14px/1 system-ui, -apple-system, Segoe UI, Roboto;
  }
  #pwa-panel {
    position: fixed; right: 16px; bottom: 64px; z-index: 2147483646;
    width: 280px; background: rgba(17,23,39,.98); color: #e5e7eb;
    border-radius: 14px; padding: 12px; display: none; backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,.08);
  }
  html[data-theme="light"] #pwa-panel { background: #f6f7f9; color: #0f172a; }
  #pwa-panel.open { display: block; }
  #pwa-panel h4 { margin: 6px 6px 8px; font-size: 12px; opacity: .75; text-transform: uppercase; letter-spacing: .08em; }
  .pwa-item {
    display: flex; align-items: center; justify-content: space-between; gap: 8px;
    padding: 10px; border-radius: 10px; cursor: pointer; user-select: none;
  }
  .pwa-item:hover { background: rgba(127,127,127,.12); }
  .pwa-kbd { font: 12px ui-monospace, Menlo, Consolas, monospace; opacity: .7; }
  .pwa-switch { position: relative; width: 46px; height: 28px; background: rgba(148,163,184,.25); border-radius: 999px; }
  .pwa-switch i { position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: #3b82f6; border-radius: 50%; transition: .2s; }
  .pwa-switch.on { background: rgba(59,130,246,.25); }
  .pwa-switch.on i { left: 21px; }
  .pwa-badge { border: 1px solid rgba(148,163,184,.45); padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="src/main.tsx"></script>

  <!-- Minimal built-in menu -->
  <button id="pwa-fab" title="App menu" aria-haspopup="true" aria-expanded="false">☰ Menu</button>
  <div id="pwa-panel" role="menu" aria-label="App menu">
    <h4>Quick actions</h4>
    <div class="pwa-item" id="pwa-install"><span>Install app to Home Screen</span><span class="pwa-kbd">PWA</span></div>
    <div class="pwa-item" id="pwa-reload"><span>Reload</span><span class="pwa-kbd">Ctrl/⌘ R</span></div>
    <h4>Appearance</h4>
    <div class="pwa-item" id="pwa-theme"><span>Dark Mode</span><span class="pwa-switch" id="pwa-theme-switch"><i></i></span></div>
    <h4>Status</h4>
    <div class="pwa-item" id="pwa-status"><span>Offline</span><span class="pwa-badge" id="pwa-offline">Checking…</span></div>
  </div>

  <script id="pwa-theme-script">
  (function(){
    function $(id){ return document.getElementById(id); }
    const root = document.documentElement;
    const metaTheme = $('meta-theme-color');
    let deferredPrompt = null;

    function isIOS(){
      const ua = navigator.userAgent || navigator.vendor || "";
      return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && (navigator).maxTouchPoints > 1);
    }
    function isStandalone(){
      return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (navigator).standalone === true;
    }
    function applyTheme(theme){
      const isDark = theme === 'dark';
      root.setAttribute('data-theme', isDark ? 'dark' : 'light');
      const sw = $('pwa-theme-switch');
      if (sw) sw.classList.toggle('on', isDark);
      if (metaTheme) metaTheme.setAttribute('content', isDark ? '#0b1220' : '#ffffff');
    }
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(saved ? saved : (prefersDark ? 'dark' : 'light'));
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e)=>{
        if(!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light');
      });
    }

    function openPanel(panel, fab){
      if (!panel) return;
      panel.classList.add('open');
      panel.style.display = 'block';
      if (fab) fab.setAttribute('aria-expanded', 'true');
    }
    function closePanel(panel, fab){
      if (!panel) return;
      panel.classList.remove('open');
      panel.style.display = 'none';
      if (fab) fab.setAttribute('aria-expanded', 'false');
    }

    function wireMenu(){
      const fab = $('pwa-fab');
      const panel = $('pwa-panel');
      const themeItem = $('pwa-theme');
      const installItem = $('pwa-install');
      const reloadItem = $('pwa-reload');
      const offlineBadge = $('pwa-offline');

      if (fab && panel){
        fab.addEventListener('click', (e)=>{
          e.stopPropagation();
          if (panel.classList.contains('open')) closePanel(panel, fab);
          else openPanel(panel, fab);
        });
        // Close when clicking outside
        document.addEventListener('click', (e)=>{
          const t = e.target;
          if (panel.classList.contains('open') && t !== fab && !panel.contains(t)) {
            closePanel(panel, fab);
          }
        });
        // Close on Escape
        document.addEventListener('keydown', (e)=>{
          if (e.key === 'Escape' && panel.classList.contains('open')) closePanel(panel, fab);
        });
      }

      if (themeItem){
        themeItem.addEventListener('click', ()=>{
          const next = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
          localStorage.setItem('theme', next); applyTheme(next);
        });
      }

      function updateOnlineStatus(){
        if (!offlineBadge) return;
        if (navigator.onLine) { offlineBadge.textContent = 'Online'; offlineBadge.style.opacity = .8; }
        else { offlineBadge.textContent = 'Offline'; offlineBadge.style.opacity = 1; }
      }
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();

      // PWA install modes
      let installMode = 'unavailable';
      const isIos = isIOS();
      if (isIos) {
        installMode = 'ios-manual';
        if (installItem) installItem.style.opacity = 1;
      }
      window.addEventListener('beforeinstallprompt', (e)=>{
        e.preventDefault(); deferredPrompt = e;
        installMode = 'native';
        if (installItem) installItem.style.opacity = 1;
      });

      if (installItem){
        installItem.style.opacity = .6;
        installItem.addEventListener('click', async ()=>{
          if (isStandalone()) { installItem.querySelector('span').textContent = 'Installed'; return; }
          if (installMode === 'native' && deferredPrompt){
            await deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') installItem.querySelector('span').textContent = 'Installed';
            deferredPrompt = null;
          } else if (installMode === 'ios-manual') {
            alert('iPhone/iPad: Tap the Share icon in Safari, then choose "Add to Home Screen".');
          } else {
            alert('On desktop: Use your browser menu → "Install app" (Chrome/Edge).');
          }
        });
      }
      if (reloadItem){
        reloadItem.addEventListener('click', ()=> location.reload());
      }
    }

    // Register SW using RELATIVE path for GitHub Pages project sites
    if ('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('sw.js', { scope: './' }).catch(console.error);
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', wireMenu);
    } else {
      wireMenu();
    }
  })();
  </script>

  <!-- Mobile tweaks JS (RELATIVE) -->
  <!--<script src="mobile-tweaks.js" defer></script>-->
</body>
</html>
